#!/usr/bin/env node

const find = require('find');
const fs = require('fs');
const concatenate = require('concatenate');
const path = require('path');
const packageJSON = require('../package.json');

const log = console.log;

function exitWithError(msg) {
  log(msg);
  process.exit(1);
}

log('======================================');
log('========== GAW-LCOV-UNIFIER ==========');
log('======================================');
log(`Versão: ${packageJSON.version}\n`);

// Localiza os arquivos lcov gerados para cada projeto
log('Localizando arquivos a contatenar na pasta coverage...\n');

const re = new RegExp('\\' + path.sep + 'lcov.info' + '$');

const files = find.fileSync(re, 'coverage');

if (files.length < 1) {
  exitWithError(
    'Não foram encontratos arquivos lcov.info a serem contatenados.'
  );
}

log(files.length + ' arquivos localizados:');
log(JSON.stringify(files), '\n');

// Cria o diretório padrão para verficação do sonar
log('Criando diretório padrão: coverage/typescript/lcov\n');
fs.mkdirSync('coverage/typescript/lcov', { recursive: true });

// Contatena os arquivos em um único lcov
log('Concatenando arquivos...\n');
concatenate.sync(files, 'coverage/typescript/lcov/lcov.info');

log(
  files.length +
    ' arquivos concatenados com sucesso em: coverage/typescript/lcov/lcov.info\n'
);

log('======================================\n');
